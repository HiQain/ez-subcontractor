(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4750],{7294:function(e,a,t){Promise.resolve().then(t.bind(t,47089))},47089:function(e,a,t){"use strict";t.r(a),t.d(a,{default:function(){return N}});var s=t(57437),n=t(66648),c=t(18148);t(10471),t(76082),t(16260);var i=t(2265);let l=async()=>{var e,a;let t=localStorage.getItem("token"),s=await fetch("".concat("https://api.ezsubcontractor.com/api/","common/chat/users"),{headers:{Authorization:t?"Bearer ".concat(t):"",Accept:"application/json"}}),n=await s.json();return Array.isArray(null==n?void 0:null===(e=n.data)||void 0===e?void 0:e.data)?null===(a=n.data)||void 0===a?void 0:a.data:[]},r=async e=>{var a;let t=localStorage.getItem("token"),s=await fetch("".concat("https://api.ezsubcontractor.com/api/","common/chat/messages/").concat(e),{headers:{Authorization:t?"Bearer ".concat(t):"",Accept:"application/json"}}),n=await s.json();return Array.isArray(null==n?void 0:null===(a=n.data)||void 0===a?void 0:a.data)?n.data.data:[]},d=async(e,a,t)=>{let s=localStorage.getItem("token"),n=new FormData;n.append("receiver_id",e.toString()),n.append("message",a||""),t&&t.length>0&&t.forEach((e,a)=>{n.append("attachments[".concat(a,"]"),e,e.name)});let c=await fetch("".concat("https://api.ezsubcontractor.com/api/","common/chat/send-message"),{method:"POST",headers:{Authorization:s?"Bearer ".concat(s):"",Accept:"application/json"},body:n}),i=await c.json();return(null==i?void 0:i.data)||null},o=async e=>{let a=localStorage.getItem("token");try{let t=await fetch("".concat("https://api.ezsubcontractor.com/api/","common/chat/clear/").concat(e),{method:"DELETE",headers:{Authorization:a?"Bearer ".concat(a):"",Accept:"application/json"}}),s=await t.json();return(null==s?void 0:s.success)||!1}catch(e){return console.error(e),!1}},m=e=>e?e.split(" ").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" "):"",h=e=>e?e.split(" ").map(e=>e[0]).join("").toUpperCase().slice(0,2):"?";var u=t(82122),g=t.n(u);let p=null,x=()=>(p||(p=new(g())("a5491524d39dc7ccba9d",{cluster:"ap2",authEndpoint:"https://ezsubcontractor.designspartans.com/broadcasting/auth",auth:{headers:{Authorization:"Bearer ".concat(localStorage.getItem("token"))}}})),p),f=(e,a)=>{let t=x().subscribe("chat.".concat(e));return t.bind("message-sent",e=>{a(e)}),t},v=e=>{p&&p.unsubscribe("chat.".concat(e))};var j=t(16463);function N(){let e=(0,j.useRouter)(),a=(0,i.useRef)(!1),[t,u]=(0,i.useState)([]),[g,p]=(0,i.useState)([]),[x,N]=(0,i.useState)(null),[w,b]=(0,i.useState)(null),[y,S]=(0,i.useState)(""),[k,C]=(0,i.useState)(!1),_=(0,i.useRef)(null),[E,A]=(0,i.useState)(""),[D,z]=(0,i.useState)([]),[I,L]=(0,i.useState)(null),[O,R]=(0,i.useState)(!1),[B,U]=(0,i.useState)(!1),[P,T]=(0,i.useState)(""),[W,F]=(0,i.useState)(null),[H,K]=(0,i.useState)(null),[V,Z]=(0,i.useState)(null),[q,G]=(0,i.useState)(null),[J,M]=(0,i.useState)(null);(0,i.useEffect)(()=>{let e=new URLSearchParams(window.location.search);F(e.get("userId")),K(e.get("name")),Z(e.get("email")),G(e.get("phone")),M(e.get("companyName"))},[]);let Q=e=>{L(null),R(!1),"contact"===e||"media"===e?L(e):"search"===e&&R(!0)};(0,i.useEffect)(()=>{let e=e=>{"Escape"===e.key&&(L(null),R(!1),U(!1))};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[]),(0,i.useEffect)(()=>{l().then(e=>{u(a=>{let t=new Set(a.map(e=>e.id));return[...a,...e.filter(e=>!t.has(e.id))]})})},[]);let X=async e=>{C(!0);try{let a=await r(e);p(t=>{let s=t.filter(a=>a.sending&&a.receiver_id===e);return[...a,...s]})}catch(e){console.error(e),p([])}finally{C(!1)}};(0,i.useEffect)(()=>{if(x)return f(x,e=>{p(a=>[...a,e]),u(a=>Array.isArray(a)?a.map(a=>a.id===x?{...a,last_message:e.message||"\uD83D\uDCCE Attachment",last_message_time:e.created_at}:a):a)}),()=>{v(x)}},[x]),(0,i.useEffect)(()=>{_.current&&(_.current.scrollTop=_.current.scrollHeight)},[g]);let Y=async()=>{if(!x||k||!x||(!y||""===y.trim())&&0===D.length)return;let e=Date.now(),a={id:e,sender_id:0,receiver_id:x,message:y,attachment:D.map(e=>URL.createObjectURL(e)),created_at:new Date().toISOString(),sending:!0};p(e=>[...e,a]),u(e=>e.map(e=>e.id===x?{...e,last_message:y||(D.length>0?"\uD83D\uDCCE Attachment":""),last_message_time:new Date().toISOString()}:e)),S(""),z([]);try{let a=await d(x,y,D);p(t=>t.map(t=>t.id===e?{...a,sending:!1}:t))}catch(a){console.error("Send message error:",a),p(a=>a.filter(a=>a.id!==e))}},$=Array.isArray(t)?t.filter(e=>e.name.toLowerCase().includes(E.toLowerCase())):[],ee=g.filter(e=>{var a;return!!(!P.trim()||(null===(a=e.message)||void 0===a?void 0:a.toLowerCase().includes(P.toLowerCase())))}),ea=async()=>{if(x&&0!==g.length){p([]),alert("Chat cleared successfully!");try{await o(x)}catch(e){console.error("Failed to clear chat:",e)}}};return(0,i.useEffect)(()=>{if(!W)return;let e=Number(W);u(a=>a.find(a=>a.id===e)?a:[{id:e,name:H||"Unknown",email:V||"",phone:q||"",last_message:"",last_message_time:new Date().toISOString(),created_at:new Date().toISOString(),company_name:J},...a])},[W]),(0,i.useEffect)(()=>{if(!W||0===t.length||a.current)return;let s=Number(W),n=t.find(e=>e.id===s);n&&(a.current=!0,N(s),b(n),X(s),e.replace("/messages"))},[W,t,e]),(0,s.jsxs)("div",{className:"sections overflow-hidden",children:[(0,s.jsx)(c.Z,{}),(0,s.jsx)("section",{className:"chat-sec",children:(0,s.jsx)("div",{className:"container",children:(0,s.jsxs)("div",{className:"chat-wrapper",children:[(0,s.jsxs)("div",{className:"sidebar",children:[(0,s.jsx)("div",{className:"form-wrapper",children:(0,s.jsxs)("div",{className:"d-flex align-items-center gap-2",children:[(0,s.jsx)(n.default,{src:"/assets/img/icons/search-gray.svg",width:18,height:18,alt:"Search Icon",loading:"lazy"}),(0,s.jsx)("input",{type:"text",placeholder:"Search here",className:"form-control border-0 shadow-none",value:E,onChange:e=>A(e.target.value)})]})}),(0,s.jsxs)("div",{className:"chat-list",children:[$.map(e=>{let a=(e.name||"?").split(" ").map(e=>e[0]).join("").toUpperCase().slice(0,2);return(0,s.jsxs)("div",{className:"chat-item ".concat(x===e.id?"selected":""),onClick:()=>{x!==e.id&&(p([]),C(!1),N(e.id),b(e),X(e.id))},style:{cursor:"pointer"},children:[(0,s.jsx)("div",{className:"avatar",children:(0,s.jsx)("div",{className:"initials-circle",children:a})}),(0,s.jsxs)("div",{className:"chat-info",children:[(0,s.jsx)("div",{className:"chat-title",children:m(e.name)}),(0,s.jsx)("div",{className:"chat-last-message",children:e.last_message||"No messages yet"})]}),(0,s.jsx)("div",{className:"chat-meta",children:(0,s.jsx)("div",{className:"time",children:new Date(e.last_message_time).toLocaleDateString()})})]},e.id)}),0===$.length&&(0,s.jsx)("div",{className:"text-center p-4",children:"No results found"})]})]}),(0,s.jsxs)("div",{className:"main-chat",children:[(0,s.jsxs)("div",{className:"chat-header",children:[w?(0,s.jsx)("div",{className:"chat-header-left",children:(0,s.jsxs)("div",{className:"chat-header-info",children:[(0,s.jsx)("div",{className:"chat-name",children:m(w.name)}),(0,s.jsx)("div",{className:"chat-time",children:new Date(w.created_at).toLocaleString()})]})}):(0,s.jsx)("div",{className:"chat-header-left",children:(0,s.jsxs)("div",{className:"chat-header-info",children:[(0,s.jsx)("div",{className:"chat-name",children:"Select a user to start chat"}),(0,s.jsx)("div",{className:"chat-time",children:"Select a user to start chat"})]})}),w&&(0,s.jsx)("div",{className:"chat-header-right",children:(0,s.jsxs)("div",{className:"dropdown-container",children:[(0,s.jsx)("button",{className:"more-options",children:"⋯"}),(0,s.jsxs)("div",{className:"dropdown-menu",children:[(0,s.jsx)("div",{className:"dropdown-item",onClick:()=>Q("contact"),children:"View contact"}),(0,s.jsx)("div",{className:"dropdown-item",onClick:()=>Q("search"),children:"Search"}),(0,s.jsx)("div",{className:"dropdown-item",onClick:ea,children:"Clear chat"})]})]})})]}),O&&(0,s.jsxs)("div",{className:"d-flex align-items-center me-3",style:{maxWidth:"340px",background:"white",padding:"8px 12px",borderRadius:"12px",margin:"16px auto",boxShadow:"0 2px 8px rgba(0,0,0,0.2)"},children:[(0,s.jsx)(n.default,{src:"/assets/img/icons/search-gray.svg",width:18,height:18,alt:"Search Icon",loading:"lazy"}),(0,s.jsx)("input",{type:"text",placeholder:"Search messages...",className:"form-control border-0 shadow-none ms-2",autoFocus:!0,style:{background:"transparent",outline:"none",fontSize:"0.95rem",flex:1,minWidth:0},value:P,onChange:e=>T(e.target.value)}),(0,s.jsx)("button",{className:"btn p-0 ms-2",onClick:()=>R(!1),style:{background:"none",border:"none",fontSize:"1.2rem",lineHeight:1,color:"#888"},children:"\xd7"})]}),(0,s.jsx)("div",{className:"chat-messages",ref:_,children:w?k&&0===g.length?(0,s.jsx)("div",{className:"text-center p-4",children:"Loading messages..."}):0===ee.length?(0,s.jsx)("div",{className:"text-center p-4",children:"No messages found"}):ee.map(e=>(0,s.jsx)("div",{className:"message ".concat(e.sender_id===x?"incoming":"outgoing"),children:(0,s.jsx)("div",{className:"message-content",style:{minWidth:"80px"},children:(0,s.jsxs)("div",{className:"message-bubble",children:[e.attachment&&e.attachment.length>0&&(0,s.jsx)("div",{className:"message-attachments mb-2",children:e.attachment.map((e,a)=>(0,s.jsx)(n.default,{src:e,alt:"attachment-".concat(a),width:200,height:200,className:"rounded-md"},a))}),e.message&&(0,s.jsx)("div",{className:"message-text",children:e.message}),(0,s.jsx)("div",{className:"message-meta",children:(0,s.jsx)("span",{className:"message-time",children:new Date(e.created_at).toLocaleTimeString()})})]})})},e.id)):(0,s.jsx)("div",{className:"text-center p-4",children:"Select a user to start chat"})}),w&&D.length>0&&(0,s.jsx)("div",{className:"message-input",children:D.length>0&&(0,s.jsx)("div",{className:"attachments-preview p-2",children:D.map((e,a)=>(0,s.jsxs)("div",{className:"preview-item d-flex align-items-center gap-2 mb-1",children:[(0,s.jsxs)("span",{children:["\uD83D\uDCCE ",e.name]}),(0,s.jsx)("button",{className:"btn btn-sm btn-danger",onClick:()=>{z(D.filter((e,t)=>t!==a));let e=document.getElementById("fileInput");e&&(e.value="")},children:"x"})]},a))})}),w&&(0,s.jsxs)("div",{className:"message-input",children:[(0,s.jsx)("div",{className:"form-wrapper w-100 m-0",children:(0,s.jsxs)("div",{className:"d-flex align-items-center gap-2 w-100",children:[(0,s.jsx)("input",{type:"text",placeholder:"Type a message...",className:"form-control border-0 shadow-none",value:y,onChange:e=>S(e.target.value),onKeyDown:e=>"Enter"===e.key&&Y()}),(0,s.jsx)("div",{className:"btn bg-transparent px-3 border-0",onClick:()=>{var e;return null===(e=document.getElementById("fileInput"))||void 0===e?void 0:e.click()},children:(0,s.jsx)(n.default,{src:"/assets/img/attachment.svg",width:18,height:18,alt:"Attachment",loading:"lazy"})}),(0,s.jsx)("input",{id:"fileInput",type:"file",multiple:!0,className:"d-none",onChange:e=>{e.target.files&&z(Array.from(e.target.files)),e.target.value=""}})]})}),(0,s.jsx)("div",{className:"input-actions",children:(0,s.jsx)("button",{className:"send-btn",onClick:Y,children:"➤"})})]})]}),"contact"===I&&(0,s.jsxs)("div",{className:"contact-panel",style:{minWidth:300},children:[(0,s.jsx)("button",{className:"close-btn",onClick:()=>L(null),children:"\xd7"}),(0,s.jsxs)("div",{className:"card-2 p-4 text-center",children:[(0,s.jsx)("div",{className:"d-flex align-items-center justify-content-center mx-auto mb-3",style:{width:104,height:104,borderRadius:"50%",background:"#C8DA2A",color:"#111",fontSize:"32px",fontWeight:600},children:h(null==w?void 0:w.name)}),(0,s.jsx)("div",{className:"title text-black fw-semibold fs-5 mb-2",children:m(w.name)}),(0,s.jsxs)("div",{className:"d-flex align-items-center justify-content-center gap-2 flex-wrap mb-2",children:[(0,s.jsx)(n.default,{src:"/assets/img/icons/message-dark.svg",width:20,height:20,alt:"Email",loading:"lazy"}),(0,s.jsx)("a",{href:"mailto:hello@example.com",className:"text-dark fw-medium",children:w.email})]}),(0,s.jsxs)("div",{className:"d-flex align-items-center justify-content-center gap-2 flex-wrap mb-3",children:[(0,s.jsx)(n.default,{src:"/assets/img/icons/call-dark.svg",width:20,height:20,alt:"Phone",loading:"lazy"}),(0,s.jsx)("a",{href:"tel:+10000000000",className:"text-dark fw-medium",children:w.phone})]}),(0,s.jsxs)("div",{className:"d-flex justify-content-center align-items-center gap-2 flex-wrap",children:[(0,s.jsxs)("a",{href:"#",className:"btn btn-outline-dark rounded-3 fs-14 text-dark",children:[(0,s.jsx)(n.default,{src:"/assets/img/icons/message-dark.svg",width:20,height:20,alt:"Chat Icon",loading:"lazy"}),(0,s.jsx)("span",{children:"Email"})]}),(0,s.jsxs)("a",{href:"#",className:"btn btn-outline-dark rounded-3 fs-14 text-dark",children:[(0,s.jsx)(n.default,{src:"/assets/img/icons/call-dark.svg",width:20,height:20,alt:"Chat Icon",loading:"lazy"}),(0,s.jsx)("span",{children:"Phone"})]})]})]})]})]})})})]})}},76082:function(){},16260:function(){},10471:function(){}},function(e){e.O(0,[9412,8305,4974,4225,8148,2971,7023,1744],function(){return e(e.s=7294)}),_N_E=e.O()}]);